@using System.Web.Optimization
@using Resources
@using VocaDb.Model.Domain.Users
@using VocaDb.Web.Helpers
@using SharedRes = ViewRes.SharedStrings
@inherits VocaDb.Web.Code.VocaDbPage<VocaDb.Web.Models.User.AlbumCollection>

@{
    ViewBag.Title = "Album collection for " + Model.User.Name;
	ViewBag.Parents = new[] {
		Html.ActionLink(Model.User.Name, "Details", "User", new {id = Model.User.Id}, null)
	};	
}

<div class="form-horizontal well well-transparent" data-bind="visible: true" style="display: none;">

	<div class="pull-right">
		<div class="inline-block">
			@ViewRes.EntryIndexStrings.SortBy
			@KnockoutHelpers.Dropdown(Translate.AlbumSortRuleNames.ValuesAndNamesStrings, "sort", "sortName")
			
			<div class="btn-group">
				<a data-bind="css: { active: viewMode() == 'Details' }, click: function() { viewMode('Details'); }" class="btn btn-nomargin" href="#">
					<i class="icon-list"></i>
				</a>
				<a data-bind="css: { active: viewMode() == 'Tiles' }, click: function() { viewMode('Tiles'); }" class="btn btn-nomargin" href="#">
					<i class="icon-th"></i>
				</a>
			</div>

		</div>
	</div>

	<div class="control-label">
		<i class="icon-search"></i>
	</div>
	<div class="control-group">
		<div class="controls">
			<div class="input-append">
				<input type="text" data-bind="value: searchTerm, valueUpdate: 'afterkeydown'" class="input-xlarge" placeholder="Type something..." />
				<button class="btn btn-danger" data-bind="click: function() { searchTerm(''); }, visible: searchTerm">@SharedRes.Clear</button>
			</div>
		</div>
	</div>
	
	<div class="control-group" data-bind="visible: publicCollection">
		<div class="control-label">Collection status</div>
		<div class="controls">
			<button class="btn" data-bind="click: function() { collectionStatus(''); }, css { active: collectionStatus() == '' }">Anything</button>
			<button class="btn" data-bind="click: function() { collectionStatus('Owned'); }, css { active: collectionStatus() == 'Owned' }">
				Owned
			</button>
			<button class="btn" data-bind="click: function() { collectionStatus('Wishlisted,Ordered'); }, css: { active: collectionStatus() == 'Wishlisted,Ordered' }">
				Wished or ordered
			</button>
		</div>
	</div>

	<div class="control-group">
		<div class="control-label">@EntryTypeNames.Artist</div>
		<div class="controls">
			<div style="display: inline-block;" class="input-append">
				@KnockoutHelpers.LockingAutoComplete("artistAutoComplete", "artistSearchParams", textBinding: "artistName", valBinding: "artistId")
			</div>
		</div>
	</div>

</div>

<div data-bind="css: { loading: loading }, visible: true" style="display: none;">

	<div data-bind="with: paging" class="dropdown pull-right">
		@KnockoutHelpers.EntryCount()
	</div>

	<div data-bind="with: paging">
		@KnockoutHelpers.ServerSidePaging()
	</div>

	<!-- ko if: viewMode() == 'Details' -->
	<table class="table table-striped">
		<thead>
			<tr>
				<th colspan="2">
					<a data-bind="click: function() { sort('Name') }" href="#">
						Album
						<span class="sortDirection_down" data-bind="visible: sort() == 'Name'"></span>
					</a>
				</th>
				<th data-bind="visible: publicCollection">
					Status
				</th>
				<th data-bind="visible: publicCollection">
					Media type
				</th>
				<th>
					Rating
				</th>
			</tr>
		</thead>
		<tbody data-bind="foreach: page">
			<tr>
				<td style="width: 80px">
					<a data-bind="visible: album.mainPicture && album.mainPicture.urlTinyThumb, attr: { href: vdb.utils.EntryUrlMapper.details('Album', album.id), title: album.additionalNames }" href="#" class="coverPicThumb">
						<img data-bind="attr: { src: (album.mainPicture ? album.mainPicture.urlTinyThumb : '') }" title="Cover picture" class="coverPicThumb img-rounded" />
					</a>
				</td>
				<td>
					<a data-bind="text: album.localizedName || album.defaultName, attr: { href: vdb.utils.EntryUrlMapper.details('Album', album.id), title: album.additionalNames }" href="#"></a><br />
					@KnockoutHelpers.DraftIcon("status")
					<small class="extraInfo" data-bind="text: album.artistString"></small><br />
					<small class="extraInfo" data-bind="text: $parent.resources().discTypeNames[album.discType]"></small>
				</td>
				<td data-bind="visible: $parent.publicCollection">
					<span data-bind="text: $data.purchaseStatus"></span>
				</td>
				<td data-bind="visible: $parent.publicCollection">
					<span data-bind="text: $parent.resources().albumMediaTypeNames[$data.mediaType]"></span>
				</td>
				<td>
					<span data-bind="attr: { title: rating }, foreach: $parent.ratingStars(rating)">
						<img data-bind="attr: { src: enabled ? '/Content/star.png' : '/Content/star_disabled.png' }" />
					</span>
				</td>
			</tr>
		</tbody>
	</table>
	<!-- /ko -->
	<!-- ko if: viewMode() == 'Tiles' -->
	<ul class="smallThumbs" data-bind="foreach: page">
		<li>
			<a data-bind="attr: { href: vdb.utils.EntryUrlMapper.details('Album', album.id), title: album.additionalNames }" href="#">
				<div class="pictureFrame">
					<img data-bind="attr: { src: (album.mainPicture ? album.mainPicture.urlSmallThumb : '') }, albumToolTip: album.id" alt="Preview" class="coverPic img-rounded" />
				</div>
			</a>
			<p data-bind="text: album.localizedName || album.defaultName"></p>
		</li>
	</ul>
	<!-- /ko -->

	<div data-bind="with: paging">
		@KnockoutHelpers.ServerSidePaging()
	</div>

</div>

@section BodyScripts {
@Scripts.Render("~/bundles/User/AlbumCollection")

<script type="text/javascript">

	$(document).ready(function () {

		var cultureCode = '@UICulture';
		var languageSelection = '@UserContext.LanguagePreference';
		var loggedUserId = @Model.User.Id;
		var publicCollection = @ToJS(Model.User.PublicAlbumCollection || Model.User.Id == Login.Manager.LoggedUserId);

		var rootPath = '@RootPath';
		var urlMapper = new vdb.UrlMapper(rootPath);
		var userRepo = new vdb.repositories.UserRepository(urlMapper);
		var artistRepo = new vdb.repositories.ArtistRepository(rootPath);
		var resourceRepo = new vdb.repositories.ResourceRepository(rootPath);

		var vm = new vdb.viewModels.user.AlbumCollectionViewModel(userRepo, artistRepo, resourceRepo, languageSelection, loggedUserId, cultureCode,
			publicCollection);
		ko.applyBindings(vm);

	});

</script>

}